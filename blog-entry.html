

```javascript
var io = require('socket.io').listen(5000);

io.sockets.on('connection', function (socket) {

});
```

```javascript
var should = require('should');
var io = require('socket.io-client');

var socketURL = 'http://0.0.0.0:5000';

var options ={
  transports: ['websocket'],
  'force new connection': true
};

var chatUser1 = {'name':'Tom'};
var chatUser2 = {'name':'Sally'};
var chatUser3 = {'name':'Dana'};
  
describe("Chat Server",function(){

});
```

Within the describe function we will add two tests:
```javascript
  /* Test 1 - A Single User */
  it('Should broadcast new user once they connect',function(done){
    var client = io.connect(socketURL, options);

    client.on('connect',function(data){
      client.emit('connection name',chatUser1);
    });

    client.on('new user',function(usersName){
      usersName.should.be.a('string');
      usersName.should.equal(chatUser1.name + " has joined.");
      /* If this client doesn't disconnect it will interfere 
      with the next test */
      client.disconnect()
      done() 
    });
  });
```
In the first test case we're simply testing that if a user connects, and emits their name, they should receive an event with their own name. It's important to disconnect the client once this test is over, otherwise the second test will trigger this test's 'new user' event.

```javascript
  /* Test 2 - Two Users */
  it('Should broadcast new user to all users', function(done){
    var client1 = io.connect(socketURL, options);
    
    client1.on('connect', function(data){
      client1.emit('connection name', chatUser1); 

      /* Since first client is connected, we connect
      the second client. */
      var client2 = io.connect(socketURL, options);

      client2.on('connect', function(data){
        client2.emit('connection name', chatUser2);
      });

      client2.on('new user', function(usersName){
        usersName.should.equal(chatUser2.name + " has joined.");
        client2.disconnect();
      });

    });

    var numUsers = 0;
    client1.on('new user', function(usersName){
      numUsers += 1;

      if(numUsers === 2){
        usersName.should.equal(chatUser2.name + " has joined.");
        client1.disconnect();
        done();
      }
    }); 
  });
```
The second test is a little more to digest, but it's only difference form the first test is the presence of the second client. The second test determines that both the first client and the second client receive a notice that the second client as connected.

``` Run the server
node chat-server.js
```

In another terminal
``` 
mocha -R spec
```

And both tests will fail (times out to be specific)! To pass the tests we simply update the chat-server.js to the following:
```javascript
var io = require('socket.io').listen(5000);

io.sockets.on('connection', function (socket) {
  socket.on('connection name',function(user){
    io.sockets.emit('new user', user.name + " has joined.");
  })

});
```

When you run the tests again they should both pass. Now, we'll add the third test that determines if a message sent from one client is sent to all the clients connected to the chat server.

```javascript
  /* Test 3 - User sends a message to chat room. */
  it('Should be able to broadcast messages', function(done){
    var client1, client2, client3;
    var message = 'Hello World';
    var messages = 0;

    var checkMessage = function(client){
      client.on('message', function(msg){
        message.should.equal(msg);
        client.disconnect();
        messages++;
        if(messages === 3){
          done(); 
        };
      });
    };

    client1 = io.connect(socketURL, options);
    checkMessage(client1);

    client1.on('connect', function(data){
      client2 = io.connect(socketURL, options);
      checkMessage(client2);

      client2.on('connect', function(data){
        client3 = io.connect(socketURL, options);
        checkMessage(client3);

        client3.on('connect', function(data){
          client2.send(message);
        });
      });
    });
  });
  ```
It may not initially be obvious why I'm using 3 clients, but it should be in the 4th test. If you run the tests again it should fail! We can fix this by updating the server code to look like:
```javascript
var io = require('socket.io').listen(5000);

io.sockets.on('connection', function (socket) {
  socket.on('connection name',function(user){
    io.sockets.emit('new user', user.name + " has joined.");
  });

  socket.on('message', function(msg){
    io.sockets.emit('message', msg);
  });
});
```

